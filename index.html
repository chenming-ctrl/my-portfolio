<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chenming LI | Neural Architecture Portfolio</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --bg-blur: 0px; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #fff; font-family: "Helvetica Neue", sans-serif; overflow: hidden; touch-action: none; -webkit-font-smoothing: antialiased; }
        #canvas-container { position: fixed; width: 100%; height: 100%; z-index: 1; transition: filter 1s ease; filter: blur(var(--bg-blur)); pointer-events: none; }
        
        nav { position: fixed; top: 0; left: 0; width: 100%; padding: 40px 60px; display: flex; justify-content: space-between; align-items: center; z-index: 5000; box-sizing: border-box; opacity: 0; transform: translateY(-20px); transition: 0.8s ease; pointer-events: none; }
        nav.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .nav-logo { font-size: 0.9rem; font-weight: 600; letter-spacing: 2px; cursor: pointer; color: #000; }
        .nav-links { display: flex; gap: 20px; }
        .nav-links a { text-decoration: none; color: #999; font-size: 0.6rem; text-transform: uppercase; cursor: pointer; transition: 0.3s; }
        .nav-links a:hover { color: #000; }

        .back-btn-container { position: fixed; bottom: 30px; left: 60px; z-index: 7001; opacity: 0; transform: translateY(10px); transition: 0.5s ease; pointer-events: none; }
        .back-btn-container.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .back-btn { font-size: 0.55rem; letter-spacing: 3px; color: #999; cursor: pointer; text-transform: uppercase; transition: 0.3s; padding: 10px; }

        .view-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; opacity: 0; visibility: hidden; transition: 0.8s cubic-bezier(0.165, 0.84, 0.44, 1); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .view-layer.active { opacity: 1; visibility: visible; }

        #lvl1 h1 { font-size: 3.5rem; font-weight: 100; letter-spacing: 20px; margin-bottom: 20px; text-transform: uppercase; color: #000; }
        #lvl1 p { font-size: 0.55rem; color: #aaa; letter-spacing: 8px; text-transform: uppercase; margin-top: 0; }

        .neural-grid { display: flex; gap: 70px; justify-content: center; align-items: center; width: 95%; flex-wrap: wrap; padding: 20px; transition: width 0.5s ease; }
        .stack-container { position: relative; width: 160px; height: 220px; cursor: pointer; text-align: center; perspective: 1000px; }
        .del-proj-btn { position: absolute; top: -10px; right: -10px; width: 22px; height: 22px; background: #ff4d4d; color: #fff; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; z-index: 10; cursor: pointer; border: 2px solid #fff; opacity: 0; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .stack-container:hover .del-proj-btn { opacity: 1; }
        
        /* 日志面板样式 */
        #log-panel { position: fixed; right: 40px; top: 120px; width: 240px; height: 60vh; background: rgba(255,255,255,0.7); border-left: 1px solid #eee; padding: 20px; font-size: 9px; overflow-y: auto; z-index: 100; font-family: monospace; color: #666; pointer-events: auto; display: none; }
        .log-entry { margin-bottom: 10px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; line-height: 1.4; }

        .neural-stack { position: relative; width: 140px; height: 140px; transform-style: preserve-3d; margin: 0 auto; }
        .neural-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; border: 1px solid rgba(0,0,0,0.05); overflow: hidden; transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1); box-shadow: 0 5px 15px rgba(0,0,0,0.02); display: flex; align-items: center; justify-content: center; }
        .neural-layer img { width: 100%; height: 100%; object-fit: cover; }
        .layer-1 { z-index: 5; }
        .layer-2 { z-index: 4; transform: translate(10px, -10px); opacity: 0.6; }
        .layer-3 { z-index: 3; transform: translate(20px, -20px); opacity: 0.3; }
        
        #lvl4 { background: #fbfbfb; z-index: 6000; }
        #miro-viewport { position: absolute; width: 100%; height: 100%; transform-origin: 0 0; }
        .miro-item { position: absolute; background: white; padding: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid transparent; min-width: 30px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .miro-item.selected { border-color: #4285F4 !important; }
        .miro-item img, .miro-item video { width: 100%; height: 100%; object-fit: cover; display: block; pointer-events: none; }
        .resizer { width: 12px; height: 12px; background: #4285F4; position: absolute; right: 0; bottom: 0; cursor: nwse-resize; opacity: 0; z-index: 10; }
        .miro-item.selected .resizer { opacity: 1; }

        .miro-ui { position: fixed; bottom: 80px; left: 60px; z-index: 7000; display: flex; align-items: center; gap: 15px; }
        .ui-btn { background: #fff; padding: 10px 20px; border-radius: 40px; font-size: 0.6rem; letter-spacing: 1px; cursor: pointer; border: 1px solid #eee; text-transform: uppercase; }
        #save-status { font-size: 0.5rem; font-weight: bold; text-transform: uppercase; opacity: 0; transition: 0.3s; pointer-events: none; }
        #save-status.active { opacity: 1; }
        #save-progress-container { position: fixed; bottom: 75px; left: 60px; width: 150px; height: 2px; background: #eee; display: none; z-index: 7002; }
        #save-progress-bar { width: 0%; height: 100%; background: #34A853; transition: width 0.3s ease; }

        .admin-lock { position: fixed; bottom: 30px; right: 60px; font-size: 0.4rem; color: #ccc; cursor: pointer; z-index: 7001; letter-spacing: 1px; }

        #loading-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; transition: 0.5s; }
        #loading-bar-wrap { width: 100px; height: 1px; background: #eee; position: relative; overflow: hidden; }
        #loading-bar { width: 0%; height: 100%; background: #000; transition: 0.3s; }
    </style>
</head>
<body>

<div id="loading-screen">
    <div id="loading-bar-wrap"><div id="loading-bar"></div></div>
    <p style="font-size: 0.5rem; letter-spacing: 2px; margin-top: 15px; color: #aaa;">INITIALIZING</p>
</div>

<nav id="mainNav"><div class="nav-logo" onclick="showLevel(1)">CHENMING</div><div id="dynamicNav" class="nav-links"></div></nav>
<div id="backBtnContainer" class="back-btn-container">
    <div id="addProjBtn" class="back-btn" style="display:none; margin-bottom: 10px;" onclick="createNewProject()">+ PROJECT</div>
    <div class="back-btn" onclick="handleBack()">← BACK</div>
</div>
<div id="canvas-container"><canvas id="particleCanvas"></canvas></div>

<div class="view-layer active" id="lvl1">
    <div onclick="showLevel(2)" style="cursor:pointer; text-align:center">
        <h1>CHENMING LI</h1>
        <p>Architecture & Computation Portfolio</p>
    </div>
</div>

<div id="lvl2" class="view-layer"><div class="neural-grid" id="catGrid"></div></div>
<div id="lvl3" class="view-layer">
    <div class="neural-grid" id="projGrid"></div>
    <div id="log-panel"></div>
</div>

<div id="lvl4" class="view-layer" ondragover="event.preventDefault()" ondrop="handleDrop(event)" oncontextmenu="return false;">
    <div class="lvl4-header" style="position: fixed; top: 100px; left: 60px; z-index: 7000; pointer-events: none;">
        <div id="lvl4CatTag" style="font-size: 0.45rem; color: #ccc; letter-spacing: 4px; margin-bottom: 8px;">CATEGORY</div>
        <div id="lvl4Title" class="lvl4-project-title" style="pointer-events: auto;" onblur="saveToCloud()">PROJECT TITLE</div>
    </div>
    <div id="miro-viewport"><div id="selection-marquee"></div></div>
    <div class="miro-ui" id="adminControls" style="display:none;">
        <button class="ui-btn" onclick="document.getElementById('fileInput').click()">+ MEDIA</button>
        <button class="ui-btn" onclick="addText()">+ TEXT</button>
        <button class="ui-btn" onclick="saveToCloud()">SAVE</button>
        <div id="save-progress-container"><div id="save-progress-bar"></div></div>
        <span id="save-status"></span>
    </div>
    <div class="admin-lock" onclick="checkUnlock()" id="adminInfo">ADMIN LOGIN</div>
    <input type="file" id="fileInput" hidden multiple onchange="handleUpload(event)">
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDIQ48e3qR33xhvwDawYsyzZQpexiHAHNM",
        authDomain: "chenming-portfolio.firebaseapp.com",
        databaseURL: "https://chenming-portfolio-default-rtdb.firebaseio.com",
        projectId: "chenming-portfolio",
        storageBucket: "chenming-portfolio.firebasestorage.app",
        messagingSenderId: "645974382810",
        appId: "1:645974382810:web:0d314656d71dedbb6e6de3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const portfolio = {
        'Architecture': { thumb: 'arch.jpg', projects: [] },
        'Computational': { thumb: 'Research.jpg', projects: [] },
        'Interest': { thumb: 'Interest.jpg', projects: [] },
        'Photo': { thumb: 'Photo.jpg', projects: [] },
        'Ongoing': { thumb: 'Ongoing.jpg', projects: [] }
    };

    let isAdmin = false, currentLvl = 1, currentCat = '', currentProj = null;
    let zoom = 1, panX = 0, panY = 0, isPanning = false, isDragging = false, isResizing = false, isSelecting = false, isEditingText = false;
    let dragTarget = null, startX, startY, startW, startH, startPX, startPY, selectedItems = [];
    const SNAP_SIZE = 10;
    const vp = document.getElementById('miro-viewport'), bd = document.getElementById('lvl4'), marquee = document.getElementById('selection-marquee');

    function startRealtimeSync() {
        const bar = document.getElementById('loading-bar');
        const screen = document.getElementById('loading-screen');
        bar.style.width = "80%";
        db.ref('portfolio_data').on('value', snap => {
            const data = snap.val() || {};
            Object.keys(portfolio).forEach(cat => {
                const prefix = cat[0].toLowerCase();
                portfolio[cat].projects = Object.keys(data).filter(id => id.startsWith(prefix)).map(id => ({
                    id: id, title: data[id].title || 'Untitled', thumbs: data[id].thumbs || [], layout: data[id].layout || []
                }));
            });
            bar.style.width = "100%";
            setTimeout(() => { screen.style.opacity = "0"; setTimeout(() => screen.style.display = "none", 500); }, 300);
            if(currentLvl === 2) renderCatGrid();
            if(currentLvl === 3) renderProjGrid();
        });
    }

    // --- 核心保存与分级检测逻辑 ---
    async function saveToCloud(silent = false) {
        if(!isAdmin || !currentProj) return;
        const status = document.getElementById('save-status');
        const progBar = document.getElementById('save-progress-bar');
        const progCont = document.getElementById('save-progress-container');
        
        const items = Array.from(vp.children).filter(el => el.id !== 'selection-marquee').map(el => ({ 
            html: el.innerHTML.replace('<div class="resizer"></div>', ''), 
            x: el.style.left, y: el.style.top, w: el.style.width, h: el.style.height
        }));

        const dataStr = JSON.stringify(items);
        const sizeMB = dataStr.length / (1024 * 1024);
        const timestamp = new Date().toLocaleTimeString();
        
        let logMsg = `Syncing... (${sizeMB.toFixed(1)}MB)`;
        let statusColor = "#000";

        if (sizeMB > 5) {
            logMsg = `⚠️ Heavy Data (${sizeMB.toFixed(1)}MB). Auto-Compressing...`;
            statusColor = "#FF8C00"; 
        }

        if(!silent) {
            status.innerText = logMsg;
            status.style.color = statusColor;
            status.classList.add('active');
            progCont.style.display = "block";
            progBar.style.width = "30%";
        }

        const thumbs = items.filter(it => it.html.includes('<img')).slice(0, 3).map(it => it.html.match(/src="([^"]+)"/)?.[1]);

        return db.ref('portfolio_data/' + currentProj.id).update({ 
            title: document.getElementById('lvl4Title').innerText, 
            layout: items, 
            thumbs: thumbs,
            lastUpdate: timestamp
        }).then(() => {
            db.ref(`portfolio_data/${currentProj.id}/logs`).push(`${timestamp}: Success (${sizeMB.toFixed(1)}MB)`);
            if(!silent) {
                progBar.style.width = "100%";
                status.innerText = "Done ✓";
                status.style.color = "#34A853";
                setTimeout(() => { status.classList.remove('active'); progCont.style.display = "none"; }, 1500);
            }
        }).catch(err => {
            const errType = err.message.includes("large") ? "OVERSIZE" : "AUTH_ERR";
            db.ref(`portfolio_data/${currentProj.id}/logs`).push(`${timestamp}: FAILED - ${errType}`);
            if(!silent) {
                status.innerText = `ERR: ${errType}`;
                status.style.color = "#EA4335";
                progBar.style.background = "#EA4335";
            }
        });
    }

    // --- 媒体处理 (带自动压缩) ---
    function processFiles(files, x, y) {
        Array.from(files).forEach(file => {
            const r = new FileReader();
            r.onload = (e) => {
                if (file.type.includes('image')) {
                    const img = new Image();
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        const MAX = 1200; // 强制限制最大边长
                        if(w>h && w>MAX){ h*=MAX/w; w=MAX; } else if(h>MAX){ w*=MAX/h; h=MAX; }
                        cvs.width = w; cvs.height = h;
                        cvs.getContext('2d').drawImage(img,0,0,w,h);
                        createMiroItem(`<img src="${cvs.toDataURL('image/jpeg', 0.65)}">`, x, y);
                        saveToCloud(true);
                    };
                    img.src = e.target.result;
                } else {
                    createMiroItem(`<video src="${e.target.result}" autoplay loop muted></video>`, x, y);
                    saveToCloud(true);
                }
            };
            r.readAsDataURL(file);
        });
    }

    // --- 页面切换与日志显示 ---
    function showLevel(lvl, cat = '') {
        if (currentLvl === 4 && lvl !== 4) vp.querySelectorAll('.miro-item').forEach(el => el.remove()); 
        currentLvl = lvl; if(cat) currentCat = cat;
        
        document.querySelectorAll('.view-layer').forEach(el => el.classList.remove('active'));
        document.getElementById('lvl4').style.display = (lvl === 4) ? 'flex' : 'none';
        
        const logPanel = document.getElementById('log-panel');
        const pGrid = document.getElementById('projGrid');

        if(lvl === 3) {
            renderProjGrid();
            logPanel.style.display = "block";
            pGrid.style.width = "calc(100% - 300px)";
            logPanel.innerHTML = '<div style="font-weight:bold; margin-bottom:15px; letter-spacing:1px; border-bottom:1px solid #000; padding-bottom:5px;">SYSTEM LOGS</div>';
            
            // 监听该分类下所有项目的日志
            portfolio[currentCat].projects.forEach(p => {
                db.ref(`portfolio_data/${p.id}/logs`).limitToLast(1).on('child_added', snap => {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';
                    entry.innerHTML = `<span style="color:#000; font-weight:600;">> ${p.title}</span><br>${snap.val()}`;
                    logPanel.prepend(entry);
                });
            });
        } else {
            logPanel.style.display = "none";
            pGrid.style.width = "95%";
            // 取消所有日志监听防止内存泄漏
            if(currentCat && portfolio[currentCat]) {
                portfolio[currentCat].projects.forEach(p => db.ref(`portfolio_data/${p.id}/logs`).off());
            }
        }

        if(lvl === 2) renderCatGrid();
        if(lvl === 4) { loadBoard(); resetViewport(); document.getElementById('lvl4Title').innerText = currentProj.title; document.getElementById('lvl4CatTag').innerText = currentCat; }
        
        document.getElementById('lvl' + lvl).classList.add('active');
        document.documentElement.style.setProperty('--bg-blur', [0, 15, 30, 0][lvl-1] + 'px');
        document.getElementById('mainNav').classList.toggle('visible', lvl > 1);
        document.getElementById('backBtnContainer').classList.toggle('show', lvl > 1);
        document.getElementById('addProjBtn').style.display = (lvl === 3 && isAdmin) ? 'block' : 'none';
    }

    // --- 基础交互 (保持不变) ---
    bd.onmousedown = (e) => {
        if(currentLvl !== 4 || isEditingText) return;
        const item = e.target.closest('.miro-item');
        if (e.button === 1) { isPanning = true; startX = e.clientX - panX; startY = e.clientY - panY; e.preventDefault(); return; }
        if(item && isAdmin && e.button === 0) {
            if (!e.shiftKey && !item.classList.contains('selected')) { document.querySelectorAll('.miro-item').forEach(el => el.classList.remove('selected')); }
            item.classList.add('selected'); selectedItems = Array.from(document.querySelectorAll('.miro-item.selected')); vp.appendChild(item);
            if(e.target.classList.contains('resizer')) { isResizing = true; startX = e.clientX; startY = e.clientY; startW = item.offsetWidth; startH = item.offsetHeight; }
            else { isDragging = true; dragTarget = item; startX = (e.clientX/zoom)-item.offsetLeft; startY = (e.clientY/zoom)-item.offsetTop; }
        } else if (!item && isAdmin && e.button === 0) {
            isSelecting = true; document.querySelectorAll('.miro-item').forEach(el => el.classList.remove('selected')); selectedItems = [];
            startPX = (e.clientX - panX) / zoom; startPY = (e.clientY - panY) / zoom; marquee.style.display = 'block';
        } else if (e.button === 0) { isPanning = true; startX = e.clientX - panX; startY = e.clientY - panY; }
    };

    window.onmousemove = (e) => {
        if(isPanning) { panX = e.clientX - startX; panY = e.clientY - startY; updateViewport(); }
        else if(isSelecting) {
            let currX = (e.clientX - panX) / zoom, currY = (e.clientY - panY) / zoom;
            let x = Math.min(startPX, currX), y = Math.min(startPY, currY), w = Math.abs(currX - startPX), h = Math.abs(currY - startPY);
            marquee.style.left = x + 'px'; marquee.style.top = y + 'px'; marquee.style.width = w + 'px'; marquee.style.height = h + 'px';
            document.querySelectorAll('.miro-item').forEach(el => {
                let elX = parseFloat(el.style.left), elY = parseFloat(el.style.top);
                if (elX > x && elX < x+w && elY > y && elY < y+h) el.classList.add('selected'); else if (!e.shiftKey) el.classList.remove('selected');
            });
        } else if(isAdmin && isDragging) {
            let rx = (e.clientX/zoom - startX), ry = (e.clientY/zoom - startY);
            dragTarget.style.left = Math.round(rx / SNAP_SIZE) * SNAP_SIZE + 'px'; dragTarget.style.top = Math.round(ry / SNAP_SIZE) * SNAP_SIZE + 'px';
        } else if(isAdmin && isResizing) {
            let rw = startW + (e.clientX - startX) / zoom, rh = startH + (e.clientY - startY) / zoom;
            selectedItems[0].style.width = Math.round(rw / SNAP_SIZE) * SNAP_SIZE + 'px'; selectedItems[0].style.height = Math.round(rh / SNAP_SIZE) * SNAP_SIZE + 'px';
        }
    };

    window.onmouseup = () => {
        if(isSelecting) { selectedItems = Array.from(document.querySelectorAll('.miro-item.selected')); marquee.style.display = 'none'; }
        if(isDragging || isResizing) saveToCloud(true);
        isPanning = isDragging = isResizing = isSelecting = false;
    };

    window.onkeydown = (e) => {
        if (!isAdmin || currentLvl !== 4 || isEditingText) return;
        if ((e.key === "Delete" || e.key === "Backspace") && !["INPUT", "TEXTAREA"].includes(document.activeElement.tagName)) {
            if (selectedItems.length > 0) { selectedItems.forEach(el => el.remove()); selectedItems = []; saveToCloud(true); }
        }
    };

    function renderProjGrid() {
        const grid = document.getElementById('projGrid');
        if (!portfolio[currentCat] || !portfolio[currentCat].projects.length) { grid.innerHTML = '<div style="color:#ccc; font-size:0.5rem; letter-spacing:2px;">EMPTY</div>'; return; }
        grid.innerHTML = portfolio[currentCat].projects.map(p => {
            let t = p.thumbs || [];
            return `<div class="stack-container" onclick="openProject('${p.id}')">
                ${isAdmin ? `<div class="del-proj-btn" onclick="deleteProject('${p.id}', event)">✕</div>` : ''}
                <div class="neural-stack">
                    <div class="neural-layer layer-3">${t[2] ? `<img src="${t[2]}">` : ''}</div>
                    <div class="neural-layer layer-2">${t[1] ? `<img src="${t[1]}">` : ''}</div>
                    <div class="neural-layer layer-1">${t[0] ? `<img src="${t[0]}">` : ''}</div>
                </div><div class="stack-label">${p.title}</div></div>`;
        }).join('');
    }

    function renderCatGrid() {
        document.getElementById('catGrid').innerHTML = Object.keys(portfolio).map(cat => {
            const firstProj = portfolio[cat].projects[0];
            let thumb = portfolio[cat].thumb;
            if (firstProj && firstProj.thumbs && firstProj.thumbs[0]) thumb = firstProj.thumbs[0];
            return `<div class="stack-container" onclick="showLevel(3, '${cat}')">
                <div class="neural-stack"><div class="neural-layer layer-2"></div><div class="neural-layer layer-1"><img src="${thumb}"></div></div>
                <div class="stack-label">${cat}</div></div>`;
        }).join('');
    }

    function handleBack() { if (currentLvl === 4) showLevel(3, currentCat); else if (currentLvl === 3) showLevel(2); else if (currentLvl === 2) showLevel(1); }
    function loadBoard() { if (!currentProj.layout) return; currentProj.layout.forEach(it => { const d = createMiroItem(it.html, parseInt(it.x), parseInt(it.y), it.w); d.style.height = it.h || 'auto'; }); }
    function updateViewport() { vp.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`; }
    function resetViewport() { zoom = 1; panX = 0; panY = 0; updateViewport(); }
    bd.addEventListener('wheel', e => { e.preventDefault(); const d = e.deltaY > 0 ? 0.9 : 1.1; zoom = Math.min(Math.max(zoom * d, 0.1), 5); updateViewport(); }, {passive:false});

    function createMiroItem(html, x, y, w = "300px") {
        const d = document.createElement('div'); d.className = 'miro-item'; d.style.cssText = `left:${x}px; top:${y}px; width:${w}; position:absolute;`;
        d.innerHTML = `${html}<div class="resizer"></div>`; vp.appendChild(d);
        const ed = d.querySelector('[contenteditable="true"]');
        if(ed) { ed.onfocus = () => { isEditingText = true; ed.style.cursor = 'text'; }; ed.onblur = () => { isEditingText = false; ed.style.cursor = 'move'; saveToCloud(true); }; }
        return d;
    }

    function addText() { if (isAdmin) createMiroItem(`<div contenteditable="true" style="width:100%; padding:10px; outline:none; font-size:16px;">New Text</div>`, (window.innerWidth/2-panX)/zoom, (window.innerHeight/2-panY)/zoom, "200px"); }
    function handleUpload(event) { if (isAdmin) processFiles(event.target.files, (window.innerWidth/2-panX)/zoom, (window.innerHeight/2-panY)/zoom); }
    function handleDrop(e) { e.preventDefault(); if (isAdmin) processFiles(e.dataTransfer.files, (e.clientX-panX)/zoom, (e.clientY-panY)/zoom); }
    function checkUnlock() { if(prompt("Pass:") === "li123") { isAdmin = true; document.getElementById('adminControls').style.display = 'flex'; document.getElementById('adminInfo').innerText = "ADMIN ACTIVE"; showLevel(currentLvl, currentCat); }}
    function createNewProject() { if (isAdmin && currentCat) { const n = prompt("Name:") || "New"; const id = `${currentCat[0].toLowerCase()}${Date.now()}`; db.ref('portfolio_data/'+id).set({title:n, layout:[], thumbs:[]}); }}
    function deleteProject(id, e) { e.stopPropagation(); if (isAdmin && confirm("Delete?")) db.ref('portfolio_data/' + id).remove(); }
    function openProject(id) { currentProj = portfolio[currentCat].projects.find(x => x.id === id); showLevel(4); }

    // 粒子背景保持不变
    const cvs = document.getElementById('particleCanvas'), ctx = cvs.getContext('2d');
    let pts = [], m = { x: 0, y: 0, smX: 0, smY: 0, vx: 0, vy: 0 };
    window.addEventListener('mousemove', e => { m.x = e.clientX; m.y = e.clientY; });
    class P {
        constructor() { this.x = Math.random()*cvs.width; this.y = Math.random()*cvs.height; this.bs = Math.random()*2+2; this.s = this.bs; this.c = ['#4285F4','#34A853','#FBBC05','#EA4335','#9b59b6'][Math.floor(Math.random()*5)]; this.v = {x:(Math.random()-0.5)*0.3, y:(Math.random()-0.5)*0.3}; this.st = 1; this.a = 0; }
        update() {
            this.x+=this.v.x; this.y+=this.v.y; if(this.x<0||this.x>cvs.width)this.v.x*=-1; if(this.y<0||this.y>cvs.height)this.v.y*=-1;
            let d = Math.hypot(m.smX-this.x, m.smY-this.y);
            if(d < 180) { let f = (180-d)/180; this.s = this.bs + f*25; this.st = 1 + (Math.hypot(m.vx, m.vy) * 0.15 * f); this.a = Math.atan2(m.vy, m.vx); }
            else { this.s += (this.bs-this.s)*0.1; this.st += (1-this.st)*0.1; }
            ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.a); ctx.beginPath(); ctx.ellipse(0,0,this.s*this.st, this.s, 0,0, Math.PI*2);
            ctx.fillStyle = this.c; ctx.globalAlpha = (currentLvl>1)?0.3:0.6; ctx.fill(); ctx.restore();
        }
    }
    function init() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; pts = Array.from({length: 120}, () => new P()); }
    function animate() {
        ctx.clearRect(0,0,cvs.width, cvs.height);
        let px = m.smX, py = m.smY; m.smX += (m.x - m.smX)*0.1; m.smY += (m.y - m.smY)*0.1; m.vx = m.smX-px; m.vy = m.smY-py;
        pts.forEach(p => p.update()); requestAnimationFrame(animate);
    }
    window.onload = () => { init(); animate(); startRealtimeSync(); };
    window.onresize = init;
    document.getElementById('dynamicNav').innerHTML = Object.keys(portfolio).map(cat => `<a onclick="showLevel(3, '${cat}')">${cat}</a>`).join('');
</script>
</body>
</html>
