<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chenming LI | Architecture Portfolio</title>
    <style>
        :root { --bg-blur: 0px; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #fff; font-family: "Helvetica Neue", sans-serif; overflow: hidden; touch-action: none; -webkit-font-smoothing: antialiased; }
        #canvas-container { position: fixed; width: 100%; height: 100%; z-index: 1; transition: filter 1s ease; filter: blur(var(--bg-blur)); pointer-events: none; }
        
        nav { position: fixed; top: 0; left: 0; width: 100%; padding: 40px 60px; display: flex; justify-content: space-between; align-items: center; z-index: 5000; box-sizing: border-box; opacity: 0; transform: translateY(-20px); transition: 0.8s ease; pointer-events: none; }
        nav.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .nav-logo { font-size: 0.9rem; font-weight: 600; letter-spacing: 2px; cursor: pointer; color: #000; }
        .nav-links { display: flex; gap: 20px; }
        .nav-links a { text-decoration: none; color: #999; font-size: 0.6rem; text-transform: uppercase; cursor: pointer; transition: 0.3s; }
        .nav-links a:hover { color: #000; }

        .back-btn-container { position: fixed; bottom: 30px; left: 60px; z-index: 7001; opacity: 0; transform: translateY(10px); transition: 0.5s ease; pointer-events: none; }
        .back-btn-container.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .back-btn { font-size: 0.55rem; letter-spacing: 3px; color: #999; cursor: pointer; text-transform: uppercase; padding: 10px; }

        .view-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; opacity: 0; visibility: hidden; transition: 0.8s cubic-bezier(0.165, 0.84, 0.44, 1); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .view-layer.active { opacity: 1; visibility: visible; }

        #lvl1 h1 { font-size: 3.5rem; font-weight: 100; letter-spacing: 20px; margin-bottom: 20px; text-transform: uppercase; color: #000; }
        #lvl1 p { font-size: 0.55rem; color: #aaa; letter-spacing: 8px; text-transform: uppercase; margin-top: 0; }

        .neural-grid { display: flex; gap: 70px; justify-content: center; align-items: center; width: 95%; flex-wrap: wrap; padding: 20px; }
        .stack-container { position: relative; width: 160px; height: 220px; cursor: pointer; text-align: center; perspective: 1000px; }
        .neural-stack { position: relative; width: 140px; height: 140px; transform-style: preserve-3d; margin: 0 auto; transition: transform 0.6s; }
        .neural-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; border: 1px solid rgba(0,0,0,0.05); overflow: hidden; transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1); box-shadow: 0 5px 15px rgba(0,0,0,0.02); display: flex; align-items: center; justify-content: center; }
        .neural-layer img { width: 100%; height: 100%; object-fit: cover; }
        .layer-1 { z-index: 5; }
        .layer-2 { z-index: 4; transform: translate(10px, -10px); opacity: 0.6; }
        .layer-3 { z-index: 3; transform: translate(20px, -20px); opacity: 0.3; }
        .stack-container:hover .layer-1 { transform: translate(-15px, 15px) rotate(-3deg); box-shadow: 15px 15px 30px rgba(0,0,0,0.1); }
        .stack-label { margin-top: 35px; font-size: 0.6rem; letter-spacing: 3px; text-transform: uppercase; color: #bbb; }

        /* ÂõõÁ∫ßÁîªÂ∏ÉÊ†∑Âºè */
        #lvl4 { background: #fbfbfb; z-index: 6000; display: none; }
        #miro-viewport { position: absolute; width: 100%; height: 100%; transform-origin: 0 0; }
        .miro-item { position: absolute; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid transparent; user-select: none; -webkit-user-drag: none; }
        .miro-item.selected { outline: 2px solid #4285F4; }
        .miro-item img, .miro-item video { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        
        /* Áº©ÊîæÊâãÊüÑÔºö‰ªÖÂú®ÈÄâ‰∏≠Êó∂ÊòæÁ§∫ */
        .resizer { width: 10px; height: 10px; background: #4285F4; position: absolute; right: 0; bottom: 0; cursor: nwse-resize; opacity: 0; transition: 0.2s; }
        .miro-item.selected .resizer { opacity: 1; }

        .miro-text-box { padding: 10px; font-size: 1.2rem; line-height: 1.4; color: #333; outline: none; min-width: 50px; }
        .miro-text-box[contenteditable="true"] { user-select: text; cursor: text; }
        
        .upload-wrapper { width: 100%; height: 100%; position: relative; background: #f9f9f9; display: flex; align-items: center; justify-content: center; }
        .pct-tag { position: absolute; top: 5px; right: 5px; background: #4285F4; color: white; font-size: 9px; padding: 2px 4px; border-radius: 2px; font-family: monospace; }

        .miro-ui { position: fixed; bottom: 80px; left: 60px; z-index: 7000; display: flex; align-items: center; gap: 15px; }
        .ui-btn { background: #fff; padding: 10px 20px; border-radius: 40px; font-size: 0.6rem; letter-spacing: 1px; cursor: pointer; border: 1px solid #eee; text-transform: uppercase; }
        .admin-lock { position: fixed; bottom: 30px; right: 60px; font-size: 0.45rem; color: #ccc; cursor: pointer; z-index: 8000; letter-spacing: 1.5px; }
        
        #loading-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; transition: 0.5s opacity; }
        #loading-bar { width: 0%; height: 1px; background: #000; transition: 0.3s; }
    </style>
</head>
<body>

<div id="loading-screen">
    <div style="width: 100px; height: 1px; background: #eee; position: relative; overflow: hidden;"><div id="loading-bar"></div></div>
</div>

<div id="canvas-container"><canvas id="particleCanvas"></canvas></div>
<div class="admin-lock" onclick="checkUnlock()" id="adminInfo">ADMIN LOGIN</div>
<nav id="mainNav"><div class="nav-logo" onclick="showLevel(1)">CHENMING</div><div id="dynamicNav" class="nav-links"></div></nav>

<div id="backBtnContainer" class="back-btn-container">
    <div id="addProjBtn" class="back-btn" style="display:none; color: #34A853; margin-bottom:10px;" onclick="createNewProject()">+ NEW PROJECT</div>
    <div class="back-btn" onclick="handleBack()">‚Üê BACK</div>
</div>

<div class="view-layer active" id="lvl1">
    <div onclick="showLevel(2)" style="cursor:pointer; text-align:center; z-index:100; position:relative;">
        <h1>CHENMING LI</h1>
        <p>Architecture & Computation Portfolio</p>
    </div>
</div>
<div id="lvl2" class="view-layer"><div class="neural-grid" id="catGrid"></div></div>
<div id="lvl3" class="view-layer"><div class="neural-grid" id="projGrid"></div></div>
<div id="lvl4" class="view-layer">
    <div class="lvl4-header" style="position: fixed; top: 100px; left: 60px; z-index: 7000; pointer-events: none;">
        <div id="lvl4CatTag" style="font-size: 0.45rem; color: #ccc; letter-spacing: 4px; margin-bottom: 8px;">CATEGORY</div>
        <div id="lvl4Title" style="pointer-events: auto; outline:none; font-size: 1.5rem;" contenteditable="true" onblur="saveToCloud()">PROJECT TITLE</div>
    </div>
    <div id="miro-viewport"></div>
    <div class="miro-ui" id="adminControls" style="display:none;">
        <button class="ui-btn" onclick="document.getElementById('fileInput').click()">+ MEDIA</button>
        <button class="ui-btn" onclick="addText()">+ TEXT</button>
        <button class="ui-btn" onclick="addLink()">+ LINK</button>
    </div>
    <input type="file" id="fileInput" hidden multiple onchange="handleUpload(event)">
</div>

<script>
    const CONFIG = {
        owner: 'chenming-ctrl',
        repo: 'my-portfolio-data',
        path: 'portfolio_data.json',
        get token() { return (localStorage.getItem('gh_token') || '').trim(); }
    };

    let portfolio_data = {}, isAdmin = false, currentLvl = 1, currentCat = '', currentProj = null;
    let zoom = 1, panX = 0, panY = 0, isPanning = false, isDragging = false, dragTarget = null, startX, startY;

    const vp = document.getElementById('miro-viewport'), bd = document.getElementById('lvl4');

    async function handleUpload(e) {
        if(!isAdmin || !currentProj) return;
        const files = e.target ? e.target.files : e;
        const dropX = (e.clientX !== undefined) ? (e.clientX - panX) / zoom : 100;
        const dropY = (e.clientY !== undefined) ? (e.clientY - panY) / zoom : 100;

        for (const file of files) {
            // Á´ãÂç≥ÂàõÂª∫Âç†‰ΩçÁ¨¶Ôºö20%ÈÄèÊòéÂ∫¶ÔºåÂ∏¶ËøõÂ∫¶Ê†áÁ≠æÔºåÊ≠§Êó∂Â∑≤ÁªèÂèØ‰ª•ÁßªÂä®
            const placeholder = createMiroItem(
                `<div class="upload-wrapper" style="opacity:0.3;">
                    <div class="pct-tag">0%</div>
                    <div style="font-size:9px; color:#999;">UPLOADING...</div>
                </div>`, `${dropX}px`, `${dropY}px`
            );
            
            const r = new FileReader();
            r.readAsDataURL(file);
            r.onload = async () => {
                const base64 = r.result.split(',')[1];
                const ext = file.name.split('.').pop().toLowerCase();
                const pctTag = placeholder.querySelector('.pct-tag');
                if(pctTag) pctTag.innerText = "50%"; // ‰º™ËøõÂ∫¶

                try {
                    const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/media/${currentProj.id}_${Date.now()}_${file.name}`, {
                        method: 'PUT', headers: { 'Authorization': `token ${CONFIG.token}` },
                        body: JSON.stringify({ message: "Upload", content: base64 })
                    });
                    if(res.ok) {
                        const data = await res.json();
                        const url = data.content.download_url;
                        let html = '';
                        if(['jpg','jpeg','png','gif','webp'].includes(ext)) html = `<img src="${url}">`;
                        else if(['mp4','webm'].includes(ext)) html = `<video src="${url}" autoplay loop muted playsinline></video>`;
                        else html = `<div style="padding:15px; border:1px solid #eee;">${file.name}</div>`;
                        
                        placeholder.innerHTML = html + `<div class="resizer"></div>`;
                        saveToCloud(true);
                    }
                } catch(err) { placeholder.remove(); }
            };
        }
    }

    function createMiroItem(content, x, y, w = "300px") {
        const d = document.createElement('div');
        d.className = 'miro-item';
        d.style.cssText = `left:${x}; top:${y}; width:${w}; position:absolute; z-index:100;`;
        if (!content.trim().startsWith('<')) content = `<div class="miro-text-box">${content}</div>`;
        d.innerHTML = `${content}<div class="resizer"></div>`;
        vp.appendChild(d);

        const txt = d.querySelector('.miro-text-box');
        if(txt) {
            d.ondblclick = (e) => { 
                if(!isAdmin) return; e.stopPropagation(); 
                txt.contentEditable = "true"; txt.focus(); 
            };
            txt.onblur = () => { txt.contentEditable = "false"; saveToCloud(true); };
        }
        return d;
    }

    function addText() { createMiroItem("Double click to edit", "100px", "100px", "200px"); saveToCloud(true); }
    function addLink() {
        const url = prompt("URL:");
        if(url) { createMiroItem(`<div style="padding:15px; background:#fff; border:1px solid #eee;">üîó <a href="${url}" target="_blank">${url}</a></div>`, "100px", "100px", "220px"); saveToCloud(true); }
    }

    // --- ËßÜËßâÊïàÊûú ---
    const cvs = document.getElementById('particleCanvas'), ctx = cvs.getContext('2d');
    let pts = [], m = { x: 0, y: 0, smX: 0, smY: 0, vx: 0, vy: 0 };
    window.addEventListener('mousemove', e => { m.x = e.clientX; m.y = e.clientY; });

    class P {
        constructor() { 
            this.x = Math.random()*cvs.width; this.y = Math.random()*cvs.height; this.bs = Math.random()*2+2; this.s = this.bs; 
            this.c = ['#4285F4','#34A853','#FBBC05','#EA4335','#9b59b6'][Math.floor(Math.random()*5)]; 
            this.v = {x:(Math.random()-0.5)*0.3, y:(Math.random()-0.5)*0.3}; this.st = 1; this.a = 0; 
        }
        update() {
            this.x+=this.v.x; this.y+=this.v.y;
            if(this.x<0||this.x>cvs.width)this.v.x*=-1; if(this.y<0||this.y>cvs.height)this.v.y*=-1;
            let d = Math.hypot(m.smX-this.x, m.smY-this.y);
            if(d < 180) {
                let f = (180-d)/180; this.s = this.bs + f*25;
                this.st = 1 + (Math.hypot(m.vx, m.vy) * 0.15 * f); this.a = Math.atan2(m.vy, m.vx);
            } else { this.s += (this.bs-this.s)*0.1; this.st += (1-this.st)*0.1; }
            ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.a); ctx.beginPath();
            ctx.ellipse(0,0,this.s*this.st, this.s, 0,0, Math.PI*2);
            ctx.fillStyle = this.c; ctx.globalAlpha = (currentLvl>1)?0.2:0.5;
            ctx.fill(); ctx.restore();
        }
    }

    function initParticles() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; pts = Array.from({length: 100}, () => new P()); }
    function animate() {
        ctx.clearRect(0,0,cvs.width, cvs.height);
        let px = m.smX, py = m.smY; m.smX += (m.x - m.smX)*0.1; m.smY += (m.y - m.smY)*0.1; m.vx = m.smX-px; m.vy = m.smY-py;
        pts.forEach(p => p.update()); requestAnimationFrame(animate);
    }

    async function initSystem() {
        const bar = document.getElementById('loading-bar');
        if(bar) bar.style.width = "40%";
        try {
            const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`, {
                headers: (isAdmin && CONFIG.token) ? { 'Authorization': `token ${CONFIG.token}` } : {}
            });
            if (res.ok) {
                const json = await res.json();
                portfolio_data = JSON.parse(decodeURIComponent(escape(atob(json.content))));
            }
        } catch (e) { console.error("Load fail", e); }
        finally {
            if(bar) bar.style.width = "100%";
            setTimeout(() => {
                const screen = document.getElementById('loading-screen');
                if(screen) screen.style.opacity = "0";
                setTimeout(() => { if(screen) screen.style.display = "none"; showLevel(1); }, 500);
            }, 300);
        }
    }

    async function saveToCloud(silent = false) {
        if(!isAdmin) return;
        if(currentProj) {
            // ÂêåÊ≠•Ê†áÈ¢òÂà∞ÂÖ®Â±ÄÊï∞ÊçÆ
            const newTitle = document.getElementById('lvl4Title').innerText;
            portfolio_data[currentProj.id].title = newTitle;
            currentProj.title = newTitle;

            const items = Array.from(vp.children).map(el => ({ 
                html: el.innerHTML.replace(/<div class=\"resizer\".*?><\/div>/g, ''), 
                x: el.style.left, y: el.style.top, w: el.style.width
            }));
            portfolio_data[currentProj.id].layout = items;
            portfolio_data[currentProj.id].thumbs = items.filter(it => it.html.includes('<img')).slice(0,3).map(it => it.html.match(/src=\"([^\"]+)\"/)?.[1]);
        }
        try {
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`;
            const getRes = await fetch(url, { headers: { 'Authorization': `token ${CONFIG.token}` }});
            const sha = (await getRes.json()).sha;
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(portfolio_data, null, 2))));
            await fetch(url, {
                method: 'PUT', headers: { 'Authorization': `token ${CONFIG.token}` },
                body: JSON.stringify({ message: "Update", content, sha })
            });
        } catch (e) {}
    }

    function checkUnlock() {
        if (isAdmin) { localStorage.clear(); window.location.href = window.location.pathname; }
        else if (prompt("Pass:") === "li123") {
            const t = prompt("Token:");
            if (t) { localStorage.setItem('is_admin_session', 'true'); localStorage.setItem('gh_token', t.trim()); window.location.href = window.location.pathname; }
        }
    }

    function showLevel(lvl, cat = '') {
        currentLvl = lvl; if(cat) currentCat = cat;
        document.querySelectorAll('.view-layer').forEach(el => el.classList.remove('active'));
        document.getElementById('lvl4').style.display = (lvl === 4) ? 'flex' : 'none';
        if(lvl === 2) renderCatGrid();
        if(lvl === 3) renderProjGrid();
        if(lvl === 4) {
            vp.innerHTML = '';
            (currentProj.layout || []).forEach(it => createMiroItem(it.html, it.x, it.y, it.w));
            document.getElementById('lvl4Title').innerText = currentProj.title;
            document.getElementById('lvl4CatTag').innerText = currentCat;
        }
        const activeLayer = document.getElementById('lvl' + lvl);
        if(activeLayer) activeLayer.classList.add('active');
        document.documentElement.style.setProperty('--bg-blur', [0, 15, 30, 0][lvl-1] + 'px');
        document.getElementById('mainNav').classList.toggle('visible', lvl > 1);
        document.getElementById('backBtnContainer').classList.toggle('show', lvl > 1);
        document.getElementById('addProjBtn').style.display = (lvl === 3 && isAdmin) ? 'block' : 'none';
    }

    function renderCatGrid() {
        const cats = ['Architecture', 'Computational', 'Interest', 'Photo', 'Ongoing'];
        document.getElementById('catGrid').innerHTML = cats.map(cat => {
            const projs = Object.keys(portfolio_data).filter(id => id.startsWith(cat[0].toLowerCase()));
            const t = (projs.length && portfolio_data[projs[0]].thumbs) ? portfolio_data[projs[0]].thumbs[0] : '';
            return `<div class="stack-container" onclick="showLevel(3, '${cat}')"><div class="neural-stack"><div class="neural-layer layer-2"></div><div class="neural-layer layer-1"><img src="${t}"></div></div><div class="stack-label">${cat}</div></div>`;
        }).join('');
    }

    function renderProjGrid() {
        const projs = Object.keys(portfolio_data).filter(id => id.startsWith(currentCat[0].toLowerCase())).map(id => ({id, ...portfolio_data[id]}));
        document.getElementById('projGrid').innerHTML = projs.map(p => {
            const t = p.thumbs || [];
            return `<div class="stack-container" onclick="openProject('${p.id}')">
                ${isAdmin ? `<div style="position:absolute;top:-10px;right:-10px;z-index:100;background:red;color:white;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;" onclick="deleteProject('${p.id}', event)">‚úï</div>`:''}
                <div class="neural-stack"><div class="neural-layer layer-3">${t[2]?`<img src="${t[2]}">`:''}</div><div class="neural-layer layer-2">${t[1]?`<img src="${t[1]}">`:''}</div><div class="neural-layer layer-1">${t[0]?`<img src="${t[0]}">`:''}</div></div><div class="stack-label">${p.title}</div></div>`;
        }).join('');
    }

    function openProject(id) { currentProj = {id, ...portfolio_data[id]}; showLevel(4); }
    function handleBack() { if (currentLvl === 4) showLevel(3); else if (currentLvl === 3) showLevel(2); else showLevel(1); }
    function createNewProject() { 
        const n = prompt("Name:"); 
        if(n) { const id = currentCat[0].toLowerCase() + Date.now(); portfolio_data[id] = {title:n, layout:[], thumbs:[]}; saveToCloud(false).then(renderProjGrid); }
    }

    function deleteProject(id, e) {
        e.stopPropagation(); if(!isAdmin) return;
        const proj = portfolio_data[id];
        if (proj.layout?.length > 0) { if (prompt(`Enter "${proj.title}" to delete:`) !== proj.title) return; }
        else if (!confirm("Delete?")) return;
        delete portfolio_data[id]; saveToCloud(false).then(renderProjGrid);
    }

    function updateViewport() { vp.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`; }
    bd.addEventListener('wheel', e => { e.preventDefault(); zoom = Math.min(Math.max(zoom * (e.deltaY > 0 ? 0.9 : 1.1), 0.1), 3); updateViewport(); }, {passive:false});
    
    bd.onmousedown = (e) => {
        // ‰∏≠ÈîÆ‰∏ìÁî®Ôºö‰ªÖÁîªÂ∏ÉÂπ≥Áßª
        if(e.button === 1) { isPanning = true; startX = e.clientX - panX; startY = e.clientY - panY; e.preventDefault(); return; }
        
        const item = e.target.closest('.miro-item');
        if(item && isAdmin) {
            if(e.target.contentEditable === "true") return; // Ê≠£Âú®ÁºñËæë‰∏çÊãñÊãΩ
            isDragging = true; dragTarget = item;
            e.preventDefault(); 
            startX = e.clientX/zoom - parseInt(item.style.left);
            startY = e.clientY/zoom - parseInt(item.style.top);
            item.style.zIndex = 1000;
            document.querySelectorAll('.miro-item').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
        } else {
            isPanning = true; startX = e.clientX - panX; startY = e.clientY - panY;
        }
    };

    window.onmousemove = (e) => {
        if(isPanning) { panX = e.clientX - startX; panY = e.clientY - startY; updateViewport(); }
        else if(isDragging) {
            let nx = e.clientX/zoom - startX, ny = e.clientY/zoom - startY, SNAP = 15;
            document.querySelectorAll('.miro-item').forEach(other => {
                if(other === dragTarget) return;
                const ox = parseInt(other.style.left), oy = parseInt(other.style.top), ow = parseInt(other.style.width);
                if(Math.abs(nx - ox) < SNAP) nx = ox;
                if(Math.abs(nx - (ox + ow)) < SNAP) nx = ox + ow + 20;
                if(Math.abs(ny - oy) < SNAP) ny = oy;
            });
            dragTarget.style.left = nx + 'px'; dragTarget.style.top = ny + 'px';
        }
    };
    window.onmouseup = () => { if(isDragging) saveToCloud(true); isPanning = isDragging = false; };
    bd.ondrop = e => { e.preventDefault(); handleUpload(e); };
    bd.ondragover = e => e.preventDefault();

    window.onload = () => { 
        initParticles(); animate(); 
        if(localStorage.getItem('is_admin_session')==='true') {
            isAdmin = true; document.getElementById('adminControls').style.display = 'flex';
            document.getElementById('adminInfo').innerText = "ADMIN (LOGOUT)";
        }
        initSystem(); 
    };
    document.getElementById('dynamicNav').innerHTML = ['Architecture', 'Computational', 'Interest', 'Photo', 'Ongoing'].map(cat => `<a onclick="showLevel(3, '${cat}')">${cat}</a>`).join('');
</script>
</body>
</html>
