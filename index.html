<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chenming LI | Design Canvas</title>
    <style>
        :root { --bg-blur: 0px; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #fff; font-family: "Helvetica Neue", sans-serif; overflow: hidden; touch-action: none; }

        /* 背景粒子 */
        #canvas-container { position: fixed; width: 100%; height: 100%; z-index: 1; transition: filter 1s ease; filter: blur(var(--bg-blur)); }
        
        /* 导航 */
        nav { position: fixed; top: 0; left: 0; width: 100%; padding: 40px 60px; display: flex; justify-content: space-between; align-items: center; z-index: 5000; box-sizing: border-box; opacity: 0; transform: translateY(-20px); transition: 0.8s ease; pointer-events: none; }
        nav.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .nav-logo { font-size: 0.9rem; font-weight: 600; letter-spacing: 2px; cursor: pointer; color: #000; }
        .nav-links { display: flex; gap: 25px; }
        .nav-links a { text-decoration: none; color: #999; font-size: 0.6rem; text-transform: uppercase; cursor: pointer; }

        .view-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; opacity: 0; visibility: hidden; transition: 0.6s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .view-layer.active { opacity: 1; visibility: visible; }

        /* 神经网络堆栈视觉特效 */
        .neural-grid { display: flex; gap: 40px; justify-content: center; align-items: center; width: 90%; flex-wrap: wrap; }
        .stack-container { position: relative; width: 140px; height: 180px; cursor: pointer; text-align: center; }
        .neural-stack { position: relative; width: 110px; height: 110px; transform-style: preserve-3d; margin: 0 auto; }
        .neural-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #eee; border: 1px solid rgba(0,0,0,0.05); overflow: hidden; transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); display: flex; align-items: center; justify-content: center; }
        .neural-layer img { width: 100%; height: 100%; object-fit: cover; }
        .placeholder-icon { color: #ccc; font-size: 20px; font-weight: 100; }
        .layer-1 { z-index: 5; } .layer-2 { z-index: 4; transform: translate(6px, -6px); opacity: 0.8; } .layer-3 { z-index: 3; transform: translate(12px, -12px); opacity: 0.5; }
        
        .stack-container:hover .layer-1 { transform: translate(-18px, -18px) scale(1.05); }
        .stack-container:hover .layer-2 { transform: translate(18px, -12px) rotate(6deg); }
        .stack-container:hover .layer-3 { transform: translate(12px, 20px) rotate(-6deg); }
        .stack-label { margin-top: 25px; font-size: 0.55rem; letter-spacing: 2px; text-transform: uppercase; color: #999; transition: 0.5s; }
        .stack-container:hover .stack-label { color: #000; transform: translateY(10px); }

        /* L4: Miro 画布核心样式 */
        #lvl4 { background: #fbfbfb; z-index: 6000; cursor: grab; }
        #miro-viewport { position: absolute; width: 100%; height: 100%; transform-origin: 0 0; }
        
        /* 四级页面标题设计 */
        .lvl4-header {
            position: fixed; top: 100px; left: 60px; z-index: 7000;
            pointer-events: none; opacity: 0; transform: translateX(-20px);
            transition: 0.8s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        .view-layer.active .lvl4-header { opacity: 1; transform: translateX(0); }
        .lvl4-project-title { font-size: 1.8rem; font-weight: 200; letter-spacing: 8px; text-transform: uppercase; margin: 0; color: #000; }
        .lvl4-category-tag { font-size: 0.5rem; letter-spacing: 3px; color: #bbb; text-transform: uppercase; margin-top: 10px; }

        .miro-item { position: absolute; cursor: move; user-select: none; background: white; padding: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid transparent; }
        .miro-item.selected { border-color: #000; }
        .miro-item img { display: block; width: 100%; height: auto; pointer-events: none; }
        
        .resizer { width: 12px; height: 12px; background: #000; position: absolute; right: -6px; bottom: -6px; cursor: nwse-resize; border-radius: 50%; border: 2px solid #fff; opacity: 0; }
        .miro-item.selected .resizer { opacity: 1; }

        .miro-ui { position: fixed; bottom: 30px; left: 30px; z-index: 7000; display: flex; gap: 10px; }
        .ui-btn { background: #fff; padding: 12px 24px; border-radius: 40px; font-size: 0.6rem; letter-spacing: 1px; cursor: pointer; border: 1px solid #eee; text-transform: uppercase; }
        .ui-btn:hover { background: #000; color: #fff; }
        
        #escHint { position: fixed; bottom: 30px; right: 30px; font-size: 0.45rem; color: #ccc; letter-spacing: 2px; z-index: 7000; pointer-events: none; text-align: right; line-height: 1.6; }
    </style>
</head>
<body>

<nav id="mainNav">
    <div class="nav-logo" onclick="showLevel(1)">CHENMING</div>
    <div id="dynamicNav" class="nav-links"></div>
</nav>

<div id="escHint">ESC: AUTO-SAVE & BACK | DEL: DELETE<br>MIDDLE-MOUSE / RIGHT-CLICK: PAN | SCROLL: ZOOM</div>
<div id="canvas-container"><canvas id="particleCanvas"></canvas></div>

<div class="view-layer active" id="lvl1">
    <div onclick="showLevel(2)" style="cursor:pointer; text-align:center">
        <h1 style="font-size:3.5rem; font-weight:200; letter-spacing:15px;">CHENMING LI</h1>
        <p style="font-size:0.7rem; color:#aaa; letter-spacing:5px; margin-top:30px;">ARCHITECTURE PORTFOLIO</p>
    </div>
</div>

<div id="lvl2" class="view-layer"><div class="neural-grid" id="catGrid"></div></div>
<div id="lvl3" class="view-layer"><div class="neural-grid" id="projGrid"></div></div>

<div id="lvl4" class="view-layer">
    <div class="lvl4-header">
        <div id="lvl4CatTag" class="lvl4-category-tag">CATEGORY</div>
        <h2 id="lvl4Title" class="lvl4-project-title">PROJECT TITLE</h2>
    </div>

    <div id="miro-viewport"></div>
    <div class="miro-ui">
        <button class="ui-btn" onclick="document.getElementById('fileInput').click()">+ ADD IMAGE</button>
        <button class="ui-btn" onclick="showLevel(3, currentCat)">CLOSE</button>
    </div>
    <input type="file" id="fileInput" hidden accept="image/*" onchange="handleUpload(event)">
</div>

<script>
    const portfolio = {
        'Architecture': { projects: Array.from({length: 4}, (_, i) => ({ id: `a${i}`, title: `Arch Case ${i+1}` })) },
        'Research': { projects: Array.from({length: 4}, (_, i) => ({ id: `r${i}`, title: `Research Lab ${i+1}` })) },
        'Photography': { projects: Array.from({length: 4}, (_, i) => ({ id: `p${i}`, title: `Film Series ${i+1}` })) }
    };

    let currentLvl = 1, currentCat = '', currentProjId = '', currentProjTitle = '';
    let zoom = 1, panX = 0, panY = 0;
    let isPanning = false, isDragging = false, isResizing = false;
    let dragTarget = null, resizeTarget = null, startX, startY, startW;
    let selectedItem = null;

    window.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            if (currentLvl === 4) { saveCurrentBoard(); showLevel(3, currentCat); }
            else if (currentLvl === 3) showLevel(2);
            else if (currentLvl === 2) showLevel(1);
        }
        if ((e.key === 'Delete' || e.key === 'Backspace') && currentLvl === 4 && selectedItem) {
            selectedItem.remove(); selectedItem = null;
        }
    });

    function showLevel(lvl, cat = '') {
        if (currentLvl === 4 && lvl !== 4) saveCurrentBoard();
        currentLvl = lvl; if(cat) currentCat = cat;
        
        document.querySelectorAll('.view-layer').forEach(el => el.classList.remove('active'));
        document.getElementById('lvl4').style.display = (lvl === 4) ? 'flex' : 'none';

        if(lvl === 1) { 
            document.getElementById('lvl1').classList.add('active'); 
            document.getElementById('mainNav').classList.remove('visible'); 
            document.documentElement.style.setProperty('--bg-blur', '0px'); isBlurred = false; 
        }
        else if(lvl === 2) { 
            renderNeuralGrid('catGrid', Object.keys(portfolio), (c) => showLevel(3, c), true); 
            document.getElementById('lvl2').classList.add('active'); 
            document.getElementById('mainNav').classList.add('visible'); 
            document.documentElement.style.setProperty('--bg-blur', '15px'); isBlurred = true; 
        }
        else if(lvl === 3) { 
            renderNeuralGrid('projGrid', portfolio[currentCat].projects, (p) => { 
                currentProjId = p.id; 
                currentProjTitle = p.title; // 记录标题
                showLevel(4); 
                loadBoard(p.id); 
            }, false); 
            document.getElementById('lvl3').classList.add('active'); 
            document.documentElement.style.setProperty('--bg-blur', '30px'); 
        }
        else if(lvl === 4) { 
            // 注入标题内容
            document.getElementById('lvl4Title').innerText = currentProjTitle;
            document.getElementById('lvl4CatTag').innerText = currentCat;
            document.getElementById('lvl4').classList.add('active'); 
            resetViewport(); 
        }
    }

    function resetViewport() { zoom = 1; panX = 0; panY = 0; updateViewport(); }

    function renderNeuralGrid(targetId, data, clickFn, isCat) {
        const grid = document.getElementById(targetId);
        grid.innerHTML = data.map((item) => {
            const title = isCat ? item : item.title;
            const id = isCat ? item : item.id;
            const savedItems = JSON.parse(localStorage.getItem(`miro_${id}`) || '[]');
            const topThree = savedItems.slice(-3).reverse(); 
            const getLayerContent = (i) => topThree[i] ? `<img src="${topThree[i].src}">` : `<div class="placeholder-icon">⬡</div>`;

            return `<div class="stack-container" id="sc-${id}">
                <div class="neural-stack">
                    <div class="neural-layer layer-3">${getLayerContent(2)}</div>
                    <div class="neural-layer layer-2">${getLayerContent(1)}</div>
                    <div class="neural-layer layer-1">${getLayerContent(0)}</div>
                </div>
                <div class="stack-label">${title}</div>
            </div>`;
        }).join('');
        data.forEach(item => { const id = isCat ? item : item.id; document.getElementById(`sc-${id}`).onclick = () => clickFn(item); });
    }

    // --- Miro 画布逻辑 ---
    const viewport = document.getElementById('miro-viewport');
    const board = document.getElementById('lvl4');

    function updateViewport() { viewport.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`; }

    board.addEventListener('wheel', e => {
        if(currentLvl !== 4) return;
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        const newZoom = Math.min(Math.max(zoom * delta, 0.1), 5);
        const mX = e.clientX, mY = e.clientY;
        panX = mX - (mX - panX) * (newZoom / zoom);
        panY = mY - (mY - panY) * (newZoom / zoom);
        zoom = newZoom; updateViewport();
    }, { passive: false });

    board.onmousedown = (e) => {
        if(currentLvl !== 4) return;
        if(e.button === 1 || e.button === 2) { isPanning = true; board.style.cursor = 'grabbing'; return; }
        const item = e.target.closest('.miro-item');
        if(selectedItem) selectedItem.classList.remove('selected');
        if(item) {
            selectedItem = item; selectedItem.classList.add('selected'); viewport.appendChild(selectedItem); 
            if(e.target.classList.contains('resizer')) { isResizing = true; resizeTarget = item; startX = e.clientX; startW = item.offsetWidth; }
            else { isDragging = true; dragTarget = item; startX = (e.clientX / zoom) - item.offsetLeft; startY = (e.clientY / zoom) - item.offsetTop; }
        } else { selectedItem = null; }
    };

    window.onmousemove = (e) => {
        updateMouse(e.clientX, e.clientY);
        if(currentLvl !== 4) return;
        if(isPanning) { panX += e.movementX; panY += e.movementY; updateViewport(); }
        else if(isResizing && resizeTarget) { resizeTarget.style.width = (startW + (e.clientX - startX) / zoom) + 'px'; }
        else if(isDragging && dragTarget) { dragTarget.style.left = (e.clientX / zoom - startX) + 'px'; dragTarget.style.top = (e.clientY / zoom - startY) + 'px'; }
    };

    window.onmouseup = () => { isPanning = false; isDragging = false; isResizing = false; dragTarget = null; board.style.cursor = 'grab'; };
    board.oncontextmenu = (e) => e.preventDefault();

    function createMiroItem(src, x, y, width = 300) {
        const div = document.createElement('div');
        div.className = 'miro-item';
        div.style.left = x + 'px'; div.style.top = y + 'px'; div.style.width = width + 'px';
        div.innerHTML = `<img src="${src}"><div class="resizer"></div>`;
        viewport.appendChild(div);
        return div;
    }

    function saveCurrentBoard() {
        if(!currentProjId) return;
        const items = Array.from(document.querySelectorAll('.miro-item')).map(el => ({
            src: el.querySelector('img').src, x: el.style.left, y: el.style.top, w: el.style.width
        }));
        localStorage.setItem(`miro_${currentProjId}`, JSON.stringify(items));
    }

    function loadBoard(id) {
        viewport.innerHTML = '';
        const data = JSON.parse(localStorage.getItem(`miro_${id}`) || '[]');
        data.forEach(item => createMiroItem(item.src, parseFloat(item.x), parseFloat(item.y), parseFloat(item.w)));
    }

    function handleUpload(e) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const item = createMiroItem(ev.target.result, (window.innerWidth/2 - panX)/zoom, (window.innerHeight/2 - panY)/zoom);
            item.dispatchEvent(new Event('mousedown', {bubbles: true})); 
        };
        reader.readAsDataURL(file);
    }

    // --- 背景粒子系统 ---
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [], isBlurred = false;
    let mouse = { x: -1000, y: -1000, targetX: -1000, targetY: -1000, vx: 0, vy: 0 };
    const updateMouse = (x, y) => { mouse.targetX = x; mouse.targetY = y; };

    class Particle {
        constructor() { this.x = Math.random()*canvas.width; this.y = Math.random()*canvas.height; this.baseSize = Math.random()*1.5 + 1; this.size = this.baseSize; this.color = ['#4285F4', '#34A853', '#FBBC05', '#EA4335', '#9b59b6'][Math.floor(Math.random()*5)]; this.v = {x:(Math.random()-0.5)*0.5, y:(Math.random()-0.5)*0.5}; this.angle = 0; this.stretch = 1; }
        update() {
            this.x += this.v.x; this.y += this.v.y;
            if(this.x<0||this.x>canvas.width) this.v.x*=-1; if(this.y<0||this.y>canvas.height) this.v.y*=-1;
            let dx = mouse.x - this.x, dy = mouse.y - this.y, d = Math.sqrt(dx*dx+dy*dy);
            if(d < 160) { let f = (160-d)/160; this.size = this.baseSize + f * 25; this.stretch = 1 + (Math.hypot(mouse.vx, mouse.vy) * 0.25 * f); this.angle = Math.atan2(mouse.vy, mouse.vx); }
            else { this.size += (this.baseSize - this.size) * 0.1; this.stretch += (1 - this.stretch) * 0.1; }
            ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle); ctx.beginPath(); ctx.ellipse(0, 0, this.size * this.stretch, this.size, 0, 0, Math.PI*2); ctx.fillStyle = this.color; ctx.globalAlpha = isBlurred?0.5:0.8; ctx.fill(); ctx.restore();
        }
    }
    function animate() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        let oldX = mouse.x, oldY = mouse.y;
        mouse.x += (mouse.targetX - mouse.x) * 0.15; mouse.y += (mouse.targetY - mouse.y) * 0.15;
        mouse.vx = mouse.x - oldX; mouse.vy = mouse.y - oldY;
        particles.forEach(p => p.update());
        requestAnimationFrame(animate);
    }
    function init() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; particles = Array.from({length: 80}, () => new Particle()); }
    init(); animate(); window.addEventListener('resize', init);
    document.getElementById('dynamicNav').innerHTML = Object.keys(portfolio).map(cat => `<a onclick="showLevel(3, '${cat}')">${cat}</a>`).join('');
</script>
</body>
</html>